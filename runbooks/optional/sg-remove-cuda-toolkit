#!/usr/bin/env bash
set -euo pipefail

TS="$(date +%Y%m%d_%H%M%S)"
LOG_DIR="/var/log/sg-runbook"
LOG="${LOG_DIR}/remove_cuda_toolkit_${TS}.log"
mkdir -p "$LOG_DIR" "/var/backups/sg-runbook"
exec > >(tee -a "$LOG") 2>&1

die(){ echo "[ERROR] $*" >&2; exit 1; }
log(){ echo "[INFO] $*"; }
warn(){ echo "[WARN] $*"; }

BRANCH="13-1"
PURGE=0
KEEP_REPO=0
PURGE_DATA=0

usage(){
  cat <<'USAGE'
Usage: sg-remove-cuda-toolkit [--branch 13-1] [--purge] [--purge-data] [--keep-repo]
  --branch X    CUDA toolkit branch (default: 13-1) -> package cuda-toolkit-X
  --purge       apt purge (remove config files too)
  --purge-data  attempt to remove leftover /usr/local/cuda-* dirs (backs up first)
  --keep-repo   keep CUDA repo/keyring/pin
USAGE
}

while [[ $# -gt 0 ]]; do
  case "$1" in
    --branch) BRANCH="${2:-}"; shift ;;
    --purge) PURGE=1 ;;
    --purge-data) PURGE_DATA=1 ;;
    --keep-repo) KEEP_REPO=1 ;;
    -h|--help) usage; exit 0 ;;
    *) die "unknown arg: $1" ;;
  esac
  shift
done

[[ $EUID -eq 0 ]] || die "run as root"

log "==== sg-remove-cuda-toolkit start ===="
log "branch: $BRANCH"
log "log: $LOG"

export DEBIAN_FRONTEND=noninteractive

PKG="cuda-toolkit-${BRANCH}"
if dpkg -s "$PKG" >/dev/null 2>&1; then
  if [[ $PURGE -eq 1 ]]; then
    log "apt purge $PKG..."
    apt-get purge -y "$PKG" || true
  else
    log "apt remove $PKG..."
    apt-get remove -y "$PKG" || true
  fi
else
  warn "$PKG not installed (skip)"
fi

log "apt autoremove..."
apt-get autoremove -y --purge || true

if [[ $KEEP_REPO -eq 0 ]]; then
  log "remove env/repo pin + keyring (if present)"
  rm -f /etc/profile.d/cuda.sh || true
  rm -f /etc/apt/preferences.d/cuda-repository-pin-600 || true
  rm -f /etc/apt/sources.list.d/cuda*.list /etc/apt/sources.list.d/nvidia-cuda*.list 2>/dev/null || true
  if dpkg -s cuda-keyring >/dev/null 2>&1; then
    apt-get purge -y cuda-keyring || true
  fi
fi

for link in /usr/local/cuda /usr/local/cuda-13; do
  if [[ -L "$link" && ! -e "$link" ]]; then
    log "remove broken symlink: $link"
    rm -f "$link"
  fi
done

if [[ $PURGE_DATA -eq 1 ]]; then
  BK="/var/backups/sg-runbook/cuda_toolkit_${TS}"
  mkdir -p "$BK"
  for d in /usr/local/cuda-*; do
    [[ -e "$d" ]] || continue
    if [[ -d "$d" ]]; then
      log "backup $d -> $BK"
      cp -a "$d" "$BK/" || true
      log "remove $d"
      rm -rf "$d"
    fi
  done
fi

log "==== sg-remove-cuda-toolkit done ===="
log "log: $LOG"
