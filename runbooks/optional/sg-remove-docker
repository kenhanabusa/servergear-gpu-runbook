#!/usr/bin/env bash
set -euo pipefail

TS="$(date +%Y%m%d_%H%M%S)"
LOG_DIR="/var/log/sg-runbook"
LOG="${LOG_DIR}/remove_docker_${TS}.log"
BK_DIR="/var/backups/sg-runbook/docker_${TS}"
mkdir -p "$LOG_DIR" "/var/backups/sg-runbook"
exec > >(tee -a "$LOG") 2>&1

die(){ echo "[ERROR] $*" >&2; exit 1; }
log(){ echo "[INFO] $*"; }
warn(){ echo "[WARN] $*"; }

PURGE=0
PURGE_DATA=0
KEEP_REPO=0

usage(){
  cat <<'USAGE'
Usage: sg-remove-docker [--purge] [--purge-data] [--keep-repo]
  --purge       apt purge (remove config files too)
  --purge-data  remove /var/lib/docker and /var/lib/containerd (backs up /etc/docker first)
  --keep-repo   keep apt repo list/keyrings
USAGE
}

while [[ $# -gt 0 ]]; do
  case "$1" in
    --purge) PURGE=1 ;;
    --purge-data) PURGE_DATA=1 ;;
    --keep-repo) KEEP_REPO=1 ;;
    -h|--help) usage; exit 0 ;;
    *) die "unknown arg: $1" ;;
  esac
  shift
done

[[ $EUID -eq 0 ]] || die "run as root"

log "==== sg-remove-docker start ===="
log "log: $LOG"

if command -v systemctl >/dev/null 2>&1; then
  log "stopping services (docker/containerd)..."
  systemctl stop docker.service docker.socket containerd.service 2>/dev/null || true
  systemctl disable docker.service docker.socket 2>/dev/null || true
fi

export DEBIAN_FRONTEND=noninteractive

DOCKER_PKGS=(docker-ce docker-ce-cli docker-buildx-plugin docker-compose-plugin containerd.io)
NVIDIA_CT_PKGS=(nvidia-container-toolkit nvidia-container-toolkit-base libnvidia-container1 libnvidia-container-tools)

if [[ $PURGE -eq 1 ]]; then
  log "apt purge docker + nvidia container toolkit packages"
  apt-get purge -y "${DOCKER_PKGS[@]}" "${NVIDIA_CT_PKGS[@]}" || true
else
  log "apt remove docker + nvidia container toolkit packages"
  apt-get remove -y "${DOCKER_PKGS[@]}" "${NVIDIA_CT_PKGS[@]}" || true
fi

log "apt autoremove"
apt-get autoremove -y --purge || true

if [[ $KEEP_REPO -eq 0 ]]; then
  log "removing repo files"
  rm -f /etc/apt/sources.list.d/docker.list || true
  rm -f /etc/apt/keyrings/docker.gpg || true
  rm -f /etc/apt/sources.list.d/nvidia-container-toolkit.list || true
  rm -f /usr/share/keyrings/nvidia-container-toolkit-keyring.gpg || true
fi

if [[ $PURGE_DATA -eq 1 ]]; then
  mkdir -p "$BK_DIR"
  if [[ -d /etc/docker ]]; then
    log "backup /etc/docker -> $BK_DIR"
    cp -a /etc/docker "$BK_DIR/" || true
    log "remove /etc/docker"
    rm -rf /etc/docker
  fi
  for d in /var/lib/docker /var/lib/containerd; do
    if [[ -d "$d" ]]; then
      log "remove $d"
      rm -rf "$d"
    fi
  done
fi

log "==== sg-remove-docker done ===="
log "log: $LOG"
