#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" && pwd)"
RB_COMMON_SYSTEM="/usr/local/lib/sg-runbook/lib/common.sh"
RB_COMMON_REPO="$(cd -- "${SCRIPT_DIR}/.." && pwd)/lib/common.sh"
if [[ -r "$RB_COMMON_SYSTEM" ]]; then
  # shellcheck source=/usr/local/lib/sg-runbook/lib/common.sh
  . "$RB_COMMON_SYSTEM"
elif [[ -r "$RB_COMMON_REPO" ]]; then
  # shellcheck source=runbooks/lib/common.sh
  . "$RB_COMMON_REPO"
else
  echo "[ERROR] common.sh not found: $RB_COMMON_SYSTEM or $RB_COMMON_REPO" >&2
  exit 1
fi

TS="$(date +%Y%m%d_%H%M%S)"
LOG_DIR="/var/log/sg-runbook"
LOG="${LOG_DIR}/remove_nvhpc_${TS}.log"
BK_DIR="/var/backups/sg-runbook/nvhpc_${TS}"
mkdir -p "$LOG_DIR" "/var/backups/sg-runbook"
exec > >(tee -a "$LOG") 2>&1

die(){ echo "[ERROR] $*" >&2; exit 1; }
log(){ echo "[INFO] $*"; }
warn(){ echo "[WARN] $*"; }

BRANCH="26.1"      # accepts 26.1 or 26-1
SUFFIX="-cuda13.0" # e.g. -cuda13.0
PURGE=0
KEEP_REPO=0
PURGE_DATA=0

usage(){
  cat <<'USAGE'
Usage: sg-remove-nvhpc [--branch 26.1] [--suffix -cuda13.0] [--purge] [--purge-data] [--keep-repo]
  --branch X     NVHPC branch (default: 26.1) accepts dot or dash
  --suffix X     package suffix (default: -cuda13.0)
  --purge        apt purge
  --purge-data   remove /opt/nvidia/hpc_sdk/Linux_x86_64/<branch> (backs up first)
  --keep-repo    keep NVHPC repo/keyring
USAGE
}

while [[ $# -gt 0 ]]; do
  case "$1" in
    --branch) BRANCH="${2:-}"; shift ;;
    --suffix) SUFFIX="${2:-}"; shift ;;
    --purge) PURGE=1 ;;
    --purge-data) PURGE_DATA=1 ;;
    --keep-repo) KEEP_REPO=1 ;;
    -h|--help) usage; exit 0 ;;
    *) die "unknown arg: $1" ;;
  esac
  shift
done

[[ $EUID -eq 0 ]] || die "run as root"

# normalize branch forms
if [[ "$BRANCH" == *-* && "$BRANCH" != *.* ]]; then
  BRANCH_DOT="${BRANCH//-/.}"
else
  BRANCH_DOT="$BRANCH"
fi
BRANCH_DASH="${BRANCH_DOT//./-}"

# normalize suffix
if [[ ! "$SUFFIX" =~ ^- ]]; then
  SUFFIX="-$SUFFIX"
fi

PKG="nvhpc-${BRANCH_DASH}${SUFFIX}"

log "==== sg-remove-nvhpc start ===="
log "branch(dot): $BRANCH_DOT"
log "package: $PKG"
log "log: $LOG"

export DEBIAN_FRONTEND=noninteractive

if dpkg -s "$PKG" >/dev/null 2>&1; then
  if [[ $PURGE -eq 1 ]]; then
    log "apt purge $PKG..."
    apt-get purge -y "$PKG" || true
  else
    log "apt remove $PKG..."
    apt-get remove -y "$PKG" || true
  fi
else
  warn "$PKG not installed (skip)"
fi

log "apt autoremove..."
apt-get autoremove -y --purge || true

log "remove profile script (if present)"
sg_safe_rm_file /etc/profile.d/nvhpc.sh /etc/profile.d || true

if [[ $KEEP_REPO -eq 0 ]]; then
  log "remove repo files"
  sg_safe_rm_file /etc/apt/sources.list.d/nvhpc.list /etc/apt/sources.list.d || true
  sg_safe_rm_file /usr/share/keyrings/nvhpc.gpg /usr/share/keyrings || true
fi

if [[ $PURGE_DATA -eq 1 ]]; then
  mkdir -p "$BK_DIR"
  ROOT="/opt/nvidia/hpc_sdk/Linux_x86_64/${BRANCH_DOT}"
  if [[ -d "$ROOT" ]]; then
    log "backup $ROOT -> $BK_DIR"
    cp -a "$ROOT" "$BK_DIR/" || true
    log "remove $ROOT"
    sg_safe_rm_dir "$ROOT" /opt/nvidia/hpc_sdk
    rmdir -p --ignore-fail-on-non-empty "/opt/nvidia/hpc_sdk/Linux_x86_64" 2>/dev/null || true
  else
    warn "$ROOT not found (skip)"
  fi
fi

log "==== sg-remove-nvhpc done ===="
log "log: $LOG"
