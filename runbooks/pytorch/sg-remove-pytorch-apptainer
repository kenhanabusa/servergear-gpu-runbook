#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" && pwd)"
RB_COMMON_SYSTEM="/usr/local/lib/sg-runbook/lib/common.sh"
RB_COMMON_REPO="$(cd -- "${SCRIPT_DIR}/.." && pwd)/lib/common.sh"
if [[ -r "$RB_COMMON_SYSTEM" ]]; then
  # shellcheck source=/usr/local/lib/sg-runbook/lib/common.sh
  . "$RB_COMMON_SYSTEM"
elif [[ -r "$RB_COMMON_REPO" ]]; then
  # shellcheck source=runbooks/lib/common.sh
  . "$RB_COMMON_REPO"
else
  echo "[ERROR] common.sh not found: $RB_COMMON_SYSTEM or $RB_COMMON_REPO" >&2
  exit 1
fi

log(){ echo "[INFO] $*"; }
warn(){ echo "[WARN] $*" >&2; }
die(){ echo "ERROR: $*" >&2; exit 1; }

usage() {
  cat <<'USAGE'
Usage:
  sg-remove-pytorch-apptainer [--dir DIR]

What it does:
  - Removes the SIF directory created by sg-install-pytorch-apptainer

Options:
  --dir DIR   Base dir (default: /opt/sg/containers/pytorch)
  -h, --help  Show this help

Example:
  sg-remove-pytorch-apptainer
USAGE
}

BASE_DIR="/opt/sg/containers/pytorch"
while [[ $# -gt 0 ]]; do
  case "$1" in
    --dir) BASE_DIR="${2:-}"; shift 2;;
    -h|--help) usage; exit 0;;
    *) die "Unknown argument: $1";;
  esac
done

mkdir -p /var/log/sg-runbook
RUN_TS="$(date +%Y%m%d_%H%M%S)"
LOGF="/var/log/sg-runbook/remove_pytorch_apptainer_${RUN_TS}.log"
exec > >(tee -a "$LOGF") 2>&1

log "==== sg-remove-pytorch-apptainer start ===="
log "log: $LOGF"
log "dir: $BASE_DIR"

if [[ ! -e "$BASE_DIR" ]]; then
  log "Nothing to remove (dir not found)."
  log "==== sg-remove-pytorch-apptainer done ===="
  exit 0
fi

sg_safe_rm_dir "$BASE_DIR" /opt/sg/containers "$BASE_DIR"
log "Removed: $BASE_DIR"
log "==== sg-remove-pytorch-apptainer done ===="
