#!/usr/bin/env bash
timestamp(){ date +%Y%m%d_%H%M%S; }
    set -euo pipefail

SCRIPT_DIR="$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" && pwd)"
RB_COMMON_SYSTEM="/usr/local/lib/sg-runbook/lib/common.sh"
RB_COMMON_REPO="$(cd -- "${SCRIPT_DIR}/.." && pwd)/lib/common.sh"
if [[ -r "$RB_COMMON_SYSTEM" ]]; then
  # shellcheck source=/usr/local/lib/sg-runbook/lib/common.sh
  . "$RB_COMMON_SYSTEM"
elif [[ -r "$RB_COMMON_REPO" ]]; then
  # shellcheck source=runbooks/lib/common.sh
  . "$RB_COMMON_REPO"
else
  echo "[ERROR] common.sh not found: $RB_COMMON_SYSTEM or $RB_COMMON_REPO" >&2
  exit 1
fi

    require_root

    RB_LOG_DIR="/var/log/sg-runbook"
    ensure_log_dir "$RB_LOG_DIR"
    LOG="$RB_LOG_DIR/remove_genai_demo_$(timestamp).log"
    exec > >(tee -a "$LOG") 2>&1

    demo_dir="/opt/sg-demos/genai-textgen"

    usage() {
      cat <<'USAGE'
    Usage:
      sg-remove-genai-demo [--demo-dir DIR]

    Removes the demo directory (including local python deps and HF cache).

    Options:
      --demo-dir DIR   (default: /opt/sg-demos/genai-textgen)
      -h, --help       show help
USAGE
    }

    while [[ $# -gt 0 ]]; do
      case "$1" in
        --demo-dir) demo_dir="$2"; shift 2;;
        -h|--help) usage; exit 0;;
        *) die "unknown arg: $1 (try --help)";;
      esac
    done

    if [[ -d "$demo_dir" ]]; then
      sg_safe_rm_dir "$demo_dir" /opt/sg-demos "${demo_dir}"
      log "Removed: $demo_dir"
    else
      log "Not found (ok): $demo_dir"
    fi

    log "Done."
