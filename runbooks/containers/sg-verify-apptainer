#!/usr/bin/env bash
set -euo pipefail
SCRIPT_DIR="$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" && pwd)"
RB_COMMON_SYSTEM="/usr/local/lib/sg-runbook/lib/common.sh"
RB_COMMON_REPO="$(cd -- "${SCRIPT_DIR}/.." && pwd)/lib/common.sh"
if [[ -r "$RB_COMMON_SYSTEM" ]]; then
  # shellcheck source=/usr/local/lib/sg-runbook/lib/common.sh
  . "$RB_COMMON_SYSTEM"
elif [[ -r "$RB_COMMON_REPO" ]]; then
  # shellcheck source=runbooks/lib/common.sh
  . "$RB_COMMON_REPO"
else
  echo "[ERROR] common.sh not found: $RB_COMMON_SYSTEM or $RB_COMMON_REPO" >&2
  exit 1
fi
require_root

if ! have_cmd apptainer; then
  die "apptainer not found"
fi

apptainer --version

if ! have_cmd nvidia-smi; then
  die "nvidia-smi not found (GPU driver not ready)"
fi

CUDA_IMAGE="${CUDA_IMAGE:-docker://nvidia/cuda:12.4.1-base-ubuntu22.04}"

log "GPU smoke test via apptainer --nv"
log "Image: $CUDA_IMAGE"
apptainer exec --nv "$CUDA_IMAGE" nvidia-smi
