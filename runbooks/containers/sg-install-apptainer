#!/usr/bin/env bash
set -euo pipefail
SCRIPT_DIR="$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" && pwd)"
RB_COMMON_SYSTEM="/usr/local/lib/sg-runbook/lib/common.sh"
RB_COMMON_REPO="$(cd -- "${SCRIPT_DIR}/.." && pwd)/lib/common.sh"
if [[ -r "$RB_COMMON_SYSTEM" ]]; then
  # shellcheck source=/usr/local/lib/sg-runbook/lib/common.sh
  . "$RB_COMMON_SYSTEM"
elif [[ -r "$RB_COMMON_REPO" ]]; then
  # shellcheck source=runbooks/lib/common.sh
  . "$RB_COMMON_REPO"
else
  echo "[ERROR] common.sh not found: $RB_COMMON_SYSTEM or $RB_COMMON_REPO" >&2
  exit 1
fi
require_root
ensure_log_dir

OUT="$RB_LOG_DIR/install_apptainer_$(_rb_now).log"
exec > >(tee -a "$OUT") 2>&1

log "==== sg-install-apptainer start ===="

if have_cmd apptainer; then
  log "apptainer already installed: $(apptainer --version || true)"
  exit 0
fi

APPLY="${RB_APPLY_APPTAINER:-/usr/local/sbin/apply_install_apptainer.sh}"
if [[ -x "$APPLY" ]]; then
  log "Running: $APPLY"
  "$APPLY"
  log "Install script finished."
else
  die "apply script not found or not executable: $APPLY (set RB_APPLY_APPTAINER=... if different)"
fi

log "==== sg-install-apptainer done ===="
log "Log: $OUT"
