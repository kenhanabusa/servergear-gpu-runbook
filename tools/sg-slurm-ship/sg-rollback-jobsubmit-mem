#!/usr/bin/env bash
set -euo pipefail
IFS=$'\n\t'

HERE="$(cd "$(dirname "$0")" && pwd)"
BKP_DIR="$HERE/out/backup"

SLURM_CONF_PATH="${SLURM_CONF_PATH:-/etc/slurm/slurm.conf}"
JOB_SUBMIT_PATH="${JOB_SUBMIT_PATH:-/etc/slurm/job_submit.lua}"
RESTORE_TS="${RESTORE_TS:-}"

for c in sudo ls sed grep; do
  if ! command -v "$c" >/dev/null 2>&1; then
    echo "ERROR: command not found: $c" >&2
    exit 2
  fi
done

if [[ ! -d "$BKP_DIR" ]]; then
  echo "ERROR: backup dir not found: $BKP_DIR" >&2
  exit 3
fi

if [[ -n "$RESTORE_TS" ]]; then
  CONF_BAK="$BKP_DIR/slurm.conf.bak.$RESTORE_TS"
  LUA_BAK="$BKP_DIR/job_submit.lua.bak.$RESTORE_TS"
else
  CONF_BAK="$(ls -1t "$BKP_DIR"/slurm.conf.bak.* 2>/dev/null | head -n 1 || true)"
  LUA_BAK="$(ls -1t "$BKP_DIR"/job_submit.lua.bak.* 2>/dev/null | head -n 1 || true)"
fi

if [[ -z "$CONF_BAK" ]] || [[ ! -f "$CONF_BAK" ]]; then
  echo "ERROR: slurm.conf backup not found" >&2
  exit 4
fi

echo "restore slurm.conf from: $CONF_BAK"
sudo cp -a "$CONF_BAK" "$SLURM_CONF_PATH"

if [[ -n "$LUA_BAK" ]] && [[ -f "$LUA_BAK" ]]; then
  echo "restore job_submit.lua from: $LUA_BAK"
  sudo cp -a "$LUA_BAK" "$JOB_SUBMIT_PATH"
else
  echo "no job_submit.lua backup found, remove active plugin file"
  sudo rm -f "$JOB_SUBMIT_PATH"
fi

sudo scontrol reconfigure

echo "rollback complete"
