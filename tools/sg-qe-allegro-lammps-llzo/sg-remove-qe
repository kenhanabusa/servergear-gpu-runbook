#!/usr/bin/env bash
set -euo pipefail
IFS=$'\n\t'
if [ -z "${BASH_VERSION:-}" ]; then exec /usr/bin/env bash "$0" "$@"; fi

LOG_DIR="/var/log/sg-runbook"
TS="$(date +%Y%m%d_%H%M%S)"
LOG="${LOG_DIR}/remove_qe_STK-011_${TS}.log"

log(){ local line="[$(date -Is)] $*"; echo "$line" >&2; mkdir -p "$LOG_DIR" 2>/dev/null||true; printf "%s\n" "$line" >> "$LOG" 2>/dev/null||true; }
die(){ log "ERROR: $*"; exit 1; }
safe_rm_dir() {
  local p="$1"
  case "$p" in
    ""|"/"|"/opt"|"/opt/sg") die "refused dangerous path: $p" ;;
    /opt/sg/*) rm -rf -- "$p" ;;
    *) die "refused path outside /opt/sg: $p" ;;
  esac
}

usage(){
  cat <<'EOF'
Usage:
  sudo sg-remove-qe [--purge-apt]

Default:
- /opt/sg/qe を削除（method=url の残骸）

Option:
- --purge-apt を付けると apt の quantum-espresso も purge（必要時のみ）
EOF
}

PURGE=0
while [[ $# -gt 0 ]]; do
  case "$1" in
    --purge-apt) PURGE=1; shift ;;
    -h|--help) usage; exit 0 ;;
    *) die "unknown arg: $1" ;;
  esac
done

[[ $EUID -eq 0 ]] || die "run as root (sudo)"
log "BEGIN remove-qe purge_apt=${PURGE}"

safe_rm_dir /opt/sg/qe 2>/dev/null || true
if (( PURGE )); then
  apt-get remove -y --purge quantum-espresso || true
  apt-get autoremove -y --purge || true
fi
log "OK"
