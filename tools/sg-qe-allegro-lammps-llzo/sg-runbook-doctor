#!/usr/bin/env bash
set -euo pipefail

RID="$(python3 - <<'PY'
import json
m=json.load(open("tools/sg-qe-allegro-lammps-llzo/manifest.json","r",encoding="utf-8"))
print(m.get("id","STK-011"))
PY
)"

PRIMARY="$(python3 - <<'PY'
import json
m=json.load(open("tools/sg-qe-allegro-lammps-llzo/manifest.json","r",encoding="utf-8"))
print(m.get("log_dir","/var/log/sg-runbook"))
PY
)"
FALLBACK="$HOME/sg-runbook-log"

pick_latest() {
  local d="$1"
  ls -1t "$d"/"${RID}"_*.jsonl 2>/dev/null | head -n 1 || true
}

latest_jsonl="$(pick_latest "$PRIMARY")"
if [ -z "$latest_jsonl" ]; then
  latest_jsonl="$(pick_latest "$FALLBACK")"
fi

echo "[doctor] rid=$RID"
echo "[doctor] primary=$PRIMARY"
echo "[doctor] fallback=$FALLBACK"
echo "[doctor] latest_jsonl=$latest_jsonl"

if [ -n "$latest_jsonl" ] && [ -s "$latest_jsonl" ]; then
  python3 - "$latest_jsonl" <<'PY'
import json, sys
path=sys.argv[1]
last=None
for line in open(path,"r",encoding="utf-8",errors="ignore"):
  line=line.strip()
  if not line: 
    continue
  try:
    obj=json.loads(line)
  except Exception:
    continue
  if obj.get("type")=="result":
    last=obj
if not last:
  print("err=-"); print("step=UNKNOWN"); print("hint=no result record found")
  sys.exit(0)
print(f"err={last.get('err','-')}")
print(f"step={last.get('step','UNKNOWN')}")
print(f"hint={last.get('hint','')}")
PY
  exit 0
fi

echo "err=-"
echo "step=UNKNOWN"
echo "hint=no logs found"
