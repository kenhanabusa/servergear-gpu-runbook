#!/usr/bin/env bash
set -euo pipefail
IFS=$'\n\t'

HERE="$(cd "$(dirname "$0")" && pwd)"
REPO_ROOT="$(cd "$HERE/../.." && pwd)"
DATE="${DATE_OVERRIDE:-$(date +%Y%m%d)}"
TS="$(date +%Y%m%d_%H%M%S)"

SG_PREFIX="${SG_PREFIX:-/opt/sg/qa/prefix/bundles/qe-allegro-lammps/${DATE}}"
QA_ROOT="${QA_ROOT:-/opt/sg/qa}"
QA_HOME="${QA_HOME:-${QA_ROOT}/home/bundle-qe-allegro-lammps-${DATE}}"
LOCK_FILE="${LOCK_FILE:-${QA_ROOT}/locks/qa.lock}"

LOG_ROOT="$HERE/out/logs/${TS}"
mkdir -p "$LOG_ROOT"
exec 9>"$LOCK_FILE"
if ! flock -n 9; then
  echo "[bundle-remove] lock busy: $LOCK_FILE" | tee "$LOG_ROOT/remove.log"
  exit 20
fi

export SG_PREFIX
export HOME="$QA_HOME"
if [[ ${EUID:-$(id -u)} -ne 0 && "$SG_PREFIX" == /opt/sg* ]]; then
  SG_PREFIX="$HOME/.local/sg"
  export SG_PREFIX
fi
export PREFIX="${PREFIX:-$HOME/.local/sg/qe-gpu-src}"
export WORKDIR="${WORKDIR:-$HOME/.cache/sg/qe-gpu-src-u}"
export LOGDIR="$LOG_ROOT/qe"
mkdir -p "$LOGDIR"

SNAP_PRE="$LOG_ROOT/opt_sg_snapshot.pre.txt"
SNAP_POST="$LOG_ROOT/opt_sg_snapshot.post.txt"
SNAP_DIFF="$LOG_ROOT/opt_sg_snapshot.diff.txt"
find /opt/sg -maxdepth 5 -printf '%y %p\n' 2>/dev/null | sort > "$SNAP_PRE" || true

/usr/bin/time -f "WALL %e" -o "$LOG_ROOT/qe_remove.wall" "$REPO_ROOT/tools/sg-qe-gpu-src-u/sg-remove-qe-gpu-src-u" > "$LOG_ROOT/qe_remove.log" 2>&1 || true
/usr/bin/time -f "WALL %e" -o "$LOG_ROOT/allegro_remove.wall" "$REPO_ROOT/tools/sg-allegro/sg-remove-allegro" --yes > "$LOG_ROOT/allegro_remove.log" 2>&1 || true
/usr/bin/time -f "WALL %e" -o "$LOG_ROOT/lmpa_remove.wall" "$REPO_ROOT/tools/sg-lammps-allegro/sg-remove-lammps-allegro" --yes > "$LOG_ROOT/lmpa_remove.log" 2>&1 || true

find /opt/sg -maxdepth 5 -printf '%y %p\n' 2>/dev/null | sort > "$SNAP_POST" || true
diff -u "$SNAP_PRE" "$SNAP_POST" > "$SNAP_DIFF" || true

if [[ -s "$SNAP_DIFF" ]]; then
  echo "[bundle-remove] WARN: /opt/sg diff detected (see $SNAP_DIFF)" | tee -a "$LOG_ROOT/remove.log"
else
  echo "[bundle-remove] PASS: /opt/sg snapshot diff is empty" | tee -a "$LOG_ROOT/remove.log"
fi

echo "$TS" > "$HERE/out/last_remove_ts.txt"
