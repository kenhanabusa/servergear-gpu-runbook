#!/usr/bin/env bash
set -euo pipefail

TOOL="sg-verify-nvhpc-u"
ts(){ date +"%Y-%m-%dT%H:%M:%S%z"; }
log(){ echo "[$(ts)] [$TOOL] $*" >&2; }
die(){ log "ERROR: $*"; exit 1; }

PREFIX="${NVHPC_PREFIX:-$HOME/.local/sg/nvhpc}"
WORKDIR="${NVHPC_WORKDIR:-$HOME/.cache/sg/nvhpc}"
LOGDIR="${NVHPC_LOGDIR:-$HOME/.cache/sg/logs/sg-nvhpc-u}"
mkdir -p "$WORKDIR" "$LOGDIR"

log "PREFIX=$PREFIX"
log "WORKDIR=$WORKDIR"
log "LOGDIR=$LOGDIR"

ENV_SH="$PREFIX/env.sh"
if [[ -f "$ENV_SH" ]]; then
  # shellcheck disable=SC1090
  source "$ENV_SH"
else
  die "env.sh not found: $ENV_SH (run install first)"
fi

command -v nvfortran >/dev/null 2>&1 || die "nvfortran not found in PATH (check env.sh)"
log "nvfortran=$(command -v nvfortran)"
nvfortran --version | head -n 2 >&2 || true

TS="$(date +%Y%m%d_%H%M%S)"
RUNDIR="$WORKDIR/verify/$TS"
mkdir -p "$RUNDIR"
LOG="$LOGDIR/verify_${TS}.log"

cat > "$RUNDIR/acc_test.f90" <<'F90'
program acc_test
  implicit none
  integer, parameter :: n=2000000
  real(8), allocatable :: a(:)
  integer :: i
  allocate(a(n))
  a = 0.0d0
  !$acc parallel loop copy(a)
  do i=1,n
     a(i) = a(i) + 1.0d0
  end do
  !$acc end parallel loop
  print *, "sum=", sum(a)
end program acc_test
F90

log "Compiling OpenACC test..."
(
  set -x
  cd "$RUNDIR"
  nvfortran -acc -Minfo=accel -O2 acc_test.f90 -o acc_test
) 2>&1 | tee "$LOG"

log "Running OpenACC test..."
(
  set -x
  cd "$RUNDIR"
  export NV_ACC_TIME="${NV_ACC_TIME:-1}"
  export NV_ACC_NOTIFY="${NV_ACC_NOTIFY:-3}"
  ./acc_test
) 2>&1 | tee -a "$LOG"

echo "=== Verify ($TOOL) OK ==="
echo "- log: $LOG"
