#!/usr/bin/env bash
set -euo pipefail
IFS=$'\n\t'

STK_ID="STK-016"
STEP="LMPA_REMOVE"
APP_ROOT="/opt/sg/lammps-allegro"
LOG_DIR="/var/log/sg-runbook"
TS="$(date +%Y%m%d_%H%M%S)"
LOG="${LOG_DIR}/remove_lammps_allegro_${STK_ID}_${TS}.log"

PURGE_SIF=0
while [[ $# -gt 0 ]]; do
  case "$1" in
    --yes) shift ;;
    --purge-sif) PURGE_SIF=1; shift ;;
    -h|--help)
      cat <<EOF
Usage: sudo sg-remove-lammps-allegro --yes [--purge-sif]
Default: keep /opt/containers/sg-lammps-allegro.sif
EOF
      exit 0 ;;
    *) echo "unknown arg: $1" >&2; exit 2 ;;
  esac
done

log(){ local s="[$(date -Is)] $*"; echo "$s"; mkdir -p "$LOG_DIR" 2>/dev/null||true; echo "$s" >>"$LOG" 2>/dev/null||true; }
die(){ log "ERROR: $*"; exit 1; }

[[ $EUID -eq 0 ]] || die "run as root (sudo)"

safe_rm_dir() {
  local p="$1"
  case "$p" in
    ""|"/"|"/opt"|"/opt/sg") die "refused dangerous path: $p" ;;
    /opt/sg/*) rm -rf -- "$p" ;;
    *) die "refused path outside /opt/sg: $p" ;;
  esac
}

safe_rm_file() {
  local p="$1"
  case "$p" in
    ""|"/"|"/opt"|"/opt/containers") die "refused dangerous file path: $p" ;;
    /opt/containers/*) rm -f -- "$p" ;;
    *) die "refused file path outside /opt/containers: $p" ;;
  esac
}

log "BEGIN ${STEP} app_root=$APP_ROOT purge_sif=$PURGE_SIF"
SIF_DEFAULT="/opt/containers/sg-lammps-allegro.sif"
SIF_PATH="$SIF_DEFAULT"
if [[ -f "$APP_ROOT/meta/sif_path.txt" ]]; then
  s="$(cat "$APP_ROOT/meta/sif_path.txt" 2>/dev/null || true)"
  [[ -n "$s" ]] && SIF_PATH="$s"
fi

safe_rm_dir "$APP_ROOT" || true
if (( PURGE_SIF == 1 )); then
  safe_rm_file "$SIF_PATH" || true
  log "PURGED SIF: $SIF_PATH"
else
  log "KEPT SIF: $SIF_PATH"
fi
log "OK"
