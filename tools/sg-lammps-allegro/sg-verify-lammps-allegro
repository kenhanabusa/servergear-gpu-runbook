#!/usr/bin/env bash
set -euo pipefail
IFS=$'\n\t'

STK_ID="STK-016"
STEP="LMPA_VERIFY"
DIR="$(cd "$(dirname "$0")" && pwd)"
PREFIX_ROOT="${SG_PREFIX:-}"
if [[ -z "${PREFIX_ROOT}" || ( ${EUID:-$(id -u)} -ne 0 && "${PREFIX_ROOT}" == /opt/sg* ) ]]; then
  if [[ ${EUID:-$(id -u)} -eq 0 ]]; then
    PREFIX_ROOT="/opt/sg"
  else
    PREFIX_ROOT="${HOME}/.local/sg"
  fi
fi

# log dir fallback
pick_log_dir() {
  local primary="/var/log/sg-runbook"
  local fallback="${HOME}/sg-runbook-log"
  if mkdir -p "$primary" 2>/dev/null; then echo "$primary"; else mkdir -p "$fallback"; echo "$fallback"; fi
}
LOG_DIR="$(pick_log_dir)"
TS="$(date +%Y%m%d_%H%M%S)"
LOG_TXT="${LOG_DIR}/verify_lammps_allegro_${STK_ID}_${TS}.log"
LOG_JSONL="${LOG_DIR}/${STK_ID}_${TS}.jsonl"

log(){ local s="[$(date -Is)] $*"; echo "$s" | tee -a "$LOG_TXT"; }
emit(){
  local payload="${1:?}"
  python3 - "$payload" <<'PY' >>"$LOG_JSONL"
import json,datetime,sys
obj=json.loads(sys.argv[1])
obj.setdefault("ts", datetime.datetime.now().astimezone().isoformat())
print(json.dumps(obj, ensure_ascii=False))
PY
}
fail(){ local err="$1" hint="$2"; log "FAIL: $hint"; emit "{\"task\":\"$STK_ID\",\"step\":\"$STEP\",\"status\":\"fail\",\"rc\":40,\"err\":\"$err\",\"hint\":\"$hint\"}"; exit 40; }
skip(){ local err="$1" hint="$2"; log "SKIP: $hint"; emit "{\"task\":\"$STK_ID\",\"step\":\"$STEP\",\"status\":\"skip\",\"rc\":20,\"err\":\"$err\",\"hint\":\"$hint\"}"; exit 20; }
pass(){ local hint="$1"; log "PASS: $hint"; emit "{\"task\":\"$STK_ID\",\"step\":\"$STEP\",\"status\":\"ok\",\"rc\":0,\"err\":\"\",\"hint\":\"$hint\"}"; exit 0; }

log "BEGIN $STEP"
log "log_dir=$LOG_DIR"

command -v apptainer >/dev/null 2>&1 || fail "E_APPTAINER_NOT_FOUND" "apptainer not found; run sudo sg-install-lammps-allegro"

# locate SIF
APP_ROOT="${PREFIX_ROOT}/lammps-allegro"
SIF_DEFAULT="/opt/containers/sg-lammps-allegro.sif"
SIF_PATH="${SG_LMPA_SIF_PATH:-${APP_ROOT}/sg-lammps-allegro.sif}"
if [[ -f "${APP_ROOT}/meta/sif_path.txt" ]]; then
  SIF_PATH_FILE="$(cat "${APP_ROOT}/meta/sif_path.txt" 2>/dev/null || true)"
  [[ -n "$SIF_PATH_FILE" ]] && SIF_PATH="$SIF_PATH_FILE"
fi
[[ -f "$SIF_PATH" ]] || SIF_PATH="$SIF_DEFAULT"
log "sif=$SIF_PATH"
[[ -f "$SIF_PATH" ]] || fail "E_SIF_MISSING" "SIF missing: $SIF_PATH (run sudo sg-install-lammps-allegro)"

# sample
SAMPLE_DIR="${SAMPLE_DIR:-$DIR/sample}"
VERIFY_MODE="${VERIFY_MODE:-smoke}"   # smoke|full
INP="${INP:-$(find "$SAMPLE_DIR" -type f -name 'in.bench1_throughput' | head -n 1 || true)}"
DATA="${DATA:-$(find "$SAMPLE_DIR" -type f -name 'llzo_51840.data' | head -n 1 || true)}"
MODEL="${MODEL_PATH:-${SAMPLE_DIR}/model.nequip.pth}"

# decide --nv
USE_NV="${USE_NV:-auto}"
NV_FLAG=""
if [[ "$USE_NV" == "1" ]]; then NV_FLAG="--nv"; fi
if [[ "$USE_NV" == "auto" ]]; then
  if command -v nvidia-smi >/dev/null 2>&1; then NV_FLAG="--nv"; fi
fi
log "apptainer_nv=${NV_FLAG:-<none>}"

if [[ "$VERIFY_MODE" == "smoke" ]]; then
  set +e
  apptainer exec ${NV_FLAG} "${SIF_PATH}" bash -lc '
set -e
LMP="$(command -v lmp 2>/dev/null || true)"
[[ -n "$LMP" ]] || LMP="$(command -v lmp_gpu 2>/dev/null || true)"
[[ -n "$LMP" ]] || { echo "E_LMP_NOT_INSTALLED lmp not found in container"; exit 40; }
"$LMP" -help >/dev/null 2>&1 || true
' > "${SAMPLE_DIR}/run_${TS}.log" 2>&1
  rc=$?
  set -e
  [[ "$rc" == "0" ]] || fail "E_LMP_RUN_FAIL" "LAMMPS smoke failed rc=$rc (see ${SAMPLE_DIR}/run_${TS}.log)"
  pass "LAMMPS smoke OK (container + lmp command)"
fi

[[ -f "$INP" && -f "$DATA" ]] || fail "E_LMP_SAMPLE_MISSING" "sample missing: run sg-fetch-sample-lammps"
[[ -f "$MODEL" ]] || fail "E_MODEL_MISSING" "model missing: run sg-fetch-model (or set MODEL_URL) first"

# run inside container
WORK_IN="/work"
CMD_IN="$WORK_IN/in.bench1_throughput"
CMD_DATA="$WORK_IN/llzo_51840.data"
CMD_MODEL="$WORK_IN/model.nequip.pth"

RUN_LOG="${SAMPLE_DIR}/run_${TS}.log"
log "RUN: apptainer exec ${NV_FLAG} --bind ${SAMPLE_DIR}:${WORK_IN} ${SIF_PATH} lmp -in ${CMD_IN}"

set +e
apptainer exec ${NV_FLAG} --bind "${SAMPLE_DIR}:${WORK_IN}" "${SIF_PATH}" bash -lc '
set -e
LMP="$(command -v lmp 2>/dev/null || true)"
[[ -n "$LMP" ]] || LMP="$(command -v lmp_gpu 2>/dev/null || true)"
[[ -n "$LMP" ]] || { echo "E_LMP_NOT_INSTALLED lmp not found in container"; exit 40; }
echo "[INFO] lmp=$LMP"
cd "'"$WORK_IN"'"
# Pass variables if the input uses them (safe even if unused)
"$LMP" -in "'"$CMD_IN"'" -var DATA "'"$CMD_DATA"'" -var MODEL "'"$CMD_MODEL"'" 
' >"$RUN_LOG" 2>&1
rc=$?
set -e

if [[ "$rc" != "0" ]]; then
  tail -n 60 "$RUN_LOG" 2>/dev/null || true
  fail "E_LMP_RUN_FAIL" "LAMMPS run failed rc=$rc (see $RUN_LOG)"
fi

# lightweight success heuristics
if grep -qiE "ERROR|E_LMP_NOT_INSTALLED" "$RUN_LOG"; then
  fail "E_LMP_RUN_FAIL" "LAMMPS output contains ERROR (see $RUN_LOG)"
fi

pass "LAMMPS + Allegro input ran (see $RUN_LOG)"
